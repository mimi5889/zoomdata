# Zoomウェビナー自動データ抽出システム 詳細仕様書

## 1. システム概要

### 1.1 システムの目的
Google Apps Scriptを使用したZoomウェビナーの事前・事後データ自動取得システム。ウェビナーの登録者情報、参加者データ、アンケート結果、Q&A結果を自動的に取得し、CSVファイルとして出力し、指定された企業にメール送信する。

### 1.2 システム構成
- **プラットフォーム**: Google Apps Script (GAS)
- **実行環境**: コンテナバインドスクリプト（スプレッドシートに紐づき）
- **データ保存**: Google Drive、Google Spreadsheet
- **通知**: Slack Webhook、Gmail
- **外部API**: Zoom API v2

### 1.3 主要機能
1. **事前データ取得**: ウェビナー開催前の登録者情報取得
2. **事後データ取得**: ウェビナー終了後の参加者・アンケート・Q&Aデータ取得
3. **自動CSV生成**: 取得データのCSVファイル自動生成
4. **自動メール送信**: 企業向けレポートの自動送信
5. **Slack通知**: 処理状況の自動通知

## 2. ファイル構成

### 2.1 メインファイル
- `registants.js` - 事前データ取得（登録者情報）
- `report.js` - 事後データ取得（参加者・アンケート・Q&A）
- `webinarList.js` - ウェビナーリスト自動更新
- `companyAdd.js` - 企業メール情報更新
- `accessToken.js` - Zoom API認証トークン管理
- `webhook.js` - Slack通知機能
- `criateMail.js` - メール作成・送信機能
- `test.js` - テスト・デバッグ機能
- `appsscript.json` - プロジェクト設定ファイル

### 2.2 設定ファイル
- `README.md` - プロジェクトドキュメント
- `プロジェクト仕様書.md` - 本仕様書

## 3. トリガー設定

### 3.1 自動実行トリガー

#### **priorityJob_registants** - 優先ジョブ（事前データ取得）
- **実行時間**: 毎日 8:00-9:00
- **実行内容**: 登録者情報の取得・更新
- **処理対象**: 21日前から当日までのウェビナー
- **優先度**: 最高（他の処理をブロック）

#### **runAllZoomChecks** - 全Zoomチェック
- **実行時間**: 毎日 0:00-1:00
- **実行内容**: 全Zoomアカウントの状態チェック
- **処理対象**: 全アカウントのウェビナー情報更新

#### **triggerSet** - ウェビナー情報の更新
- **実行時間**: 毎日 0:00-1:00, 6:00-7:00
- **実行内容**: ウェビナー情報の更新
- **目的**: ウェビナー情報の最新化

#### **webinarReportsTrigger** - ウェビナーレポート作成
- **実行時間**: 5分おき（23:00-7:00は除外）
- **実行内容**: 事後データ取得・CSV生成・メール送信
- **処理対象**: 終了時刻から35-60分後のウェビナー
- **除外時間**: 23:00-7:00（深夜・早朝は実行しない）

#### **updateEmailInfoFromCode** - 企業メール情報更新
- **実行時間**: 毎日 5:00-6:00
- **実行内容**: 企業メールアドレスの自動更新
- **処理対象**: 企業情報シートの更新

### 3.2 手動実行トリガー

#### **open** - スプレッドシート起動時
- **実行タイミング**: スプレッドシートを開いた時
- **実行内容**: カスタムメニューの作成
- **メニュー項目**: 
  - GAS実行
    - 事前参加者リスト手動実行
    - 事後データ取得

## 4. 各ファイルの詳細仕様

### 4.1 registants.js - 事前データ取得システム

#### **主要関数**

##### `priorityJob_registants()`
- **目的**: 登録者情報の一括取得・更新
- **処理内容**:
  1. 優先ジョブ状態をRUNNINGに設定
  2. 21日前から当日までのウェビナーを対象
  3. 各Zoomアカウントで登録者情報を取得
  4. 登録者数の増減をチェック
  5. CSVファイル生成・Driveアップロード
  6. 企業向けメール送信
  7. Slack通知
- **エラーハンドリング**: Googleサーバーエラー時の自動再実行（最大3回）
- **進捗管理**: 処理中断時の進捗保存・再開機能

##### `getRegistantsData(webinarId, token, topic)`
- **目的**: 特定ウェビナーの登録者データ取得
- **処理内容**:
  1. 登録者情報の取得
  2. 参加者情報の取得
  3. パネリスト情報の取得
  4. ダッシュボードデータの取得
  5. CSVデータの生成
- **戻り値**: CSVデータ文字列

##### `generateRegistantsCsv(registrants, participants, panelists, accountIndex, metricsParticipants, topic)`
- **目的**: 登録者CSVの生成
- **処理内容**:
  1. ヘッダー行の作成
  2. 参加者データの行生成
  3. 未参加者データの行生成
  4. データのソート・整形
- **戻り値**: CSV文字列

#### **データフロー**
1. スプレッドシートからウェビナー情報を読み取り
2. Zoom APIで登録者情報を取得
3. データをCSV形式に変換
4. Google Driveにファイル保存
5. 企業向けメール送信
6. Slack通知

### 4.2 report.js - 事後データ取得システム

#### **主要関数**

##### `webinarReportsTrigger()`
- **目的**: ウェビナーレポート作成のトリガー処理
- **処理内容**:
  1. 優先ジョブ状態のチェック
  2. 時間帯チェック（23:00-7:00は除外）
  3. 事後データ取得の実行
- **制御ロジック**: 優先ジョブ実行中はスキップ

##### `generateWebinarReports()`
- **目的**: 事後データ取得のメイン処理
- **処理内容**:
  1. 終了時刻から35-60分後のウェビナーを特定
  2. 出席者レポートの生成
  3. アンケート結果レポートの生成
  4. Q&A結果レポートの生成
  5. 企業向けメール下書き作成

##### `exportWebinarCsvs(webinarId, accountIndex, stockId, companyName, endTime, companyAdd)`
- **目的**: ウェビナーデータのCSV出力
- **処理内容**:
  1. 出席者レポートの生成
  2. アンケート結果レポートの生成（リトライ機能付き）
  3. Q&A結果レポートの生成
  4. フォルダ作成・ファイル保存
- **リトライ機能**: アンケートデータ取得で最大3回リトライ

##### `validateZoomDataWithRetry(fetchFn, validateFn, retryMax, webinarId, token)`
- **目的**: Zoom APIデータ取得のリトライ処理
- **処理内容**:
  1. 指定回数までデータ取得をリトライ
  2. 各リトライ間で30秒待機
  3. 最終リトライ失敗時に軽量版チェック実行
- **軽量版チェック**: `?fields=custom_survey`でアンケート存在確認

##### `checkSurveyLightweight(webinarId, token)`
- **目的**: 軽量版アンケート存在チェック
- **処理内容**: custom_surveyフィールドのみでアンケート有無を確認
- **効率性**: 全データを取得せず、存在有無のみ確認

#### **データフロー**
1. 終了時刻から35-60分後のウェビナーを特定
2. 出席者・アンケート・Q&Aデータを取得
3. 各データをCSV形式に変換
4. Google Driveにファイル保存
5. 企業向けメール下書き作成
6. Slack通知

### 4.3 webinarList.js - ウェビナーリスト管理システム

#### **主要関数**

##### `runAllZoomChecks()`
- **目的**: 全Zoomアカウントのウェビナー情報更新
- **処理内容**:
  1. 各Zoomアカウントでウェビナーリスト取得
  2. スプレッドシートの更新
  3. 除外フラグの設定

##### `setExclusionFlags()`
- **目的**: 除外対象ウェビナーのフラグ設定
- **処理内容**:
  1. 除外シートA列の除外ワードでチェック
  2. 除外シートB列の除外stockIDでチェック
  3. どちらかが一致する場合に除外フラグを設定

#### **データフロー**
1. Zoom APIでウェビナーリスト取得
2. スプレッドシートの更新
3. 除外対象の判定・フラグ設定

### 4.4 companyAdd.js - 企業情報管理システム

#### **主要関数**

##### `updateEmailInfoFromCode()`
- **目的**: 企業メールアドレスの自動更新
- **処理内容**:
  1. 企業情報シートから最新情報を取得
  2. メインシートの企業情報を更新
- **実行タイミング**: 毎日5:00-6:00

#### **データフロー**
1. 企業情報シートからデータ読み取り
2. メインシートの企業情報を更新

### 4.5 accessToken.js - 認証管理システム

#### **主要関数**

##### `getAccessToken(accountIndex)`
- **目的**: Zoom APIアクセストークンの取得
- **処理内容**:
  1. スクリプトプロパティから認証情報取得
  2. OAuth2.0認証でアクセストークン取得
  3. トークンの有効性チェック
- **戻り値**: アクセストークン文字列

##### `getZoomUserId(accountIndex)`
- **目的**: ZoomユーザーIDの取得
- **処理内容**:
  1. アクセストークンを使用してユーザー情報取得
  2. ユーザーIDの抽出
- **戻り値**: ユーザーID文字列

#### **認証フロー**
1. スクリプトプロパティから認証情報取得
2. OAuth2.0認証でアクセストークン取得
3. トークンの有効性チェック
4. API呼び出しでの使用

### 4.6 webhook.js - 通知システム

#### **主要関数**

##### `sendSlackNotification(topic, folderUrl, webhooktxt, stockId, companyAdd)`
- **目的**: Slack通知の送信
- **処理内容**:
  1. 通知メッセージの作成
  2. Slack Webhookへの送信
- **通知内容**: 処理完了、エラー発生、処理状況

##### `sendSlackNotification2(webhooktxt)`
- **目的**: エラー通知の送信
- **処理内容**: エラー内容のSlack通知

##### `sendSlackNotification3(webhooktxt)`
- **目的**: 処理状況通知の送信
- **処理内容**: 処理進捗のSlack通知

#### **通知フロー**
1. 処理状況の判定
2. 通知メッセージの作成
3. Slack Webhookへの送信

### 4.7 criateMail.js - メールシステム

#### **主要関数**

##### `createDraftMail(stockId, companyName, companyAdd, attendeeFile, surveyFile, qaFile)`
- **目的**: 企業向けメール下書きの作成
- **処理内容**:
  1. メール本文の作成
  2. 添付ファイルの設定
  3. Gmail下書きの作成
- **添付ファイル**: 出席者レポート、アンケート結果、Q&A結果

##### `createRegistantsMail(stockId, companyName, companyAdd, registantsFile)`
- **目的**: 事前データ用メール下書きの作成
- **処理内容**:
  1. 事前データ用メール本文の作成
  2. 登録者レポートの添付
  3. Gmail下書きの作成

#### **メールフロー**
1. メール本文の作成
2. 添付ファイルの設定
3. Gmail下書きの作成
4. 企業向けの自動送信準備

### 4.8 test.js - テスト・デバッグシステム

#### **主要関数**

##### `registantsTestLightweight()`
- **目的**: 事前データ取得の軽量テスト
- **処理内容**: メール送信・CSV作成・Driveアップロードなしのテスト

##### `reportTestLightweight()`
- **目的**: 事後データ取得の軽量テスト
- **処理内容**: CSV作成・Driveアップロード・メール下書き作成なしのテスト

##### `webhookTestLightweight()`
- **目的**: Webhook通知の軽量テスト
- **処理内容**: 実際の業務通知なしのテスト

##### `priorityJobStatusTest()`
- **目的**: 優先ジョブ状態管理のテスト
- **処理内容**: 状態管理ロジックの動作確認

##### `webinarReportsTriggerTest()`
- **目的**: トリガー制御ロジックのテスト
- **処理内容**: 制御ロジックの動作確認

##### `registrantsCheckLogicTest()`
- **目的**: 登録者数増減チェックロジックのテスト
- **処理内容**: 日付範囲制限の動作確認

##### `setExclusionFlagsTest()`
- **目的**: 除外フラグ設定ロジックのテスト
- **処理内容**: 除外判定ロジックの動作確認

#### **テストの特徴**
- **安全性**: 実際のデータ変更なし
- **高速性**: 記入処理なしで高速実行
- **繰り返し実行**: 何度でも実行可能
- **本番環境対応**: 本番環境でも安全に実行可能

## 5. スクリプトプロパティ設定

### 5.1 必須設定項目

#### **Zoom API認証情報**
- `ZOOM_ID_1` 〜 `ZOOM_ID_4`: 各ZoomアカウントのID
- `CLIENT_ID_1` 〜 `CLIENT_ID_4`: 各ZoomアカウントのクライアントID
- `CLIENT_SECRET_1` 〜 `CLIENT_SECRET_4`: 各Zoomアカウントのクライアントシークレット
- `ACCOUNT_ID_1` 〜 `ACCOUNT_ID_4`: 各ZoomアカウントのアカウントID

#### **システム設定**
- `MAX_ACCOUNT_INDEX`: 最大アカウント数（デフォルト: 4）
- `FOLDER_ID`: Google Driveの保存先フォルダID
- `COMPANY_EMAIL_SHEET_ID`: 企業情報シートのID

#### **通知設定**
- `SLACK_WEBHOOK_URL`: Slack通知用Webhook URL
- `CC_EMAIL`: メール送信時のCCアドレス

### 5.2 設定手順
1. Google Apps Scriptプロジェクトの設定画面を開く
2. スクリプトプロパティタブを選択
3. 各項目を追加・設定
4. 設定完了後、軽量テストで動作確認

### 5.3 Zoomアカウント追加手順

#### **5.3.1 スクリプトプロパティの追加**
新しいZoomアカウント（例：5番目）を追加する場合：

1. **Google Apps Scriptプロジェクトの設定画面を開く**
   - プロジェクト画面で「プロジェクトの設定」をクリック
   - 「スクリプトプロパティ」タブを選択

2. **新しい認証情報を追加**
   - `ZOOM_ID_5`: 新しいZoomアカウントのID
   - `CLIENT_ID_5`: 新しいZoomアカウントのクライアントID
   - `CLIENT_SECRET_5`: 新しいZoomアカウントのクライアントシークレット
   - `ACCOUNT_ID_5`: 新しいZoomアカウントのアカウントID

3. **MAX_ACCOUNT_INDEXの更新**
   - 現在の値: `4`
   - 新しい値: `5`（または追加するアカウント数に応じて）

#### **5.3.2 Zoom API設定の準備**
新しいZoomアカウントで以下を準備：

1. **Zoom App Marketplaceでの設定**
   - [Zoom App Marketplace](https://marketplace.zoom.us/)にアクセス
   - 「Develop」→「Build App」を選択
   - 「Server-to-Server OAuth」を選択
   - アプリ名、説明、会社名を入力

2. **必要な権限の設定**
   - **Webinar**: Read
   - **Meeting**: Read
   - **User**: Read

3. **認証情報の取得**
   - **Client ID**: アプリ作成時に自動生成
   - **Client Secret**: アプリ作成時に自動生成
   - **Account ID**: Zoomアカウントの管理画面で確認

#### **5.3.3 コードの確認**
追加したアカウントが正しく動作することを確認：

1. **軽量テストの実行**
   ```javascript
   // test.jsで軽量テストを実行
   registantsTestLightweight();
   reportTestLightweight();
   ```

2. **ログの確認**
   - 新しいアカウントでのAPI呼び出しが成功しているか
   - エラーが発生していないか

#### **5.3.4 動作確認**
1. **事前データ取得のテスト**
   - 新しいアカウントのウェビナーで登録者情報が取得できるか
   - CSVファイルが正しく生成されるか

2. **事後データ取得のテスト**
   - 新しいアカウントのウェビナーで参加者・アンケート・Q&Aデータが取得できるか
   - レポートが正しく生成されるか

#### **5.3.5 注意事項**
- **MAX_ACCOUNT_INDEX**: 必ず追加するアカウント数に合わせて更新
- **認証情報**: 各アカウントの認証情報は個別に設定
- **権限**: 新しいアカウントに必要な権限が付与されているか確認
- **テスト**: 本番運用前に必ず軽量テストで動作確認

#### **5.3.6 トラブルシューティング**
新しいアカウントで問題が発生した場合：

1. **認証エラーの確認**
   - Client ID、Client Secret、Account IDが正しいか
   - 権限設定が適切か

2. **API制限の確認**
   - 新しいアカウントのAPI制限に達していないか
   - レート制限に引っかかっていないか

3. **ログの詳細確認**
   - エラーメッセージの詳細を確認
   - 軽量テストで問題箇所を特定

## 6. データ構造

### 6.1 メインシート構造
- **A列**: Zoom ID
- **B列**: ウェビナーID
- **C列**: トピック
- **D列**: 開始予定時刻
- **E列**: 終了予定時刻
- **F列**: 終了時刻（実際）
- **G列**: 除外フラグ
- **H列**: 証券コード
- **I列**: 企業名
- **J列**: 企業送付先アドレス
- **K列**: 出席者レポートリンク
- **L列**: アンケート結果レポートリンク
- **M列**: Q&Aレポートリンク

### 6.2 除外シート構造
- **A列**: 除外ワード（トピックに含まれる場合除外）
- **B列**: 除外stockID（証券コードが一致する場合除外）

### 6.3 企業情報シート構造
- **A列**: 証券コード
- **B列**: 企業名
- **C列**: 企業メールアドレス

## 7. エラーハンドリング

### 7.1 エラー種別

#### **Zoom APIエラー**
- **対応**: 自動リトライ（最大3回）
- **待機時間**: 各リトライ間で30秒
- **軽量版チェック**: 最終リトライ失敗時に実行

#### **Googleサーバーエラー**
- **対応**: 自動再実行（最大3回）
- **待機時間**: 1分間隔
- **進捗保存**: 中断時の進捗保存・再開

#### **その他のエラー**
- **対応**: エラーログ記録・Slack通知
- **処理**: 該当行をスキップして継続

### 7.2 エラー通知
- **Slack通知**: エラー内容、発生時刻、処理状況
- **ログ記録**: 詳細なエラー情報の記録
- **状態管理**: エラー時の適切な状態リセット

## 8. パフォーマンス最適化

### 8.1 処理時間管理
- **リトライ回数**: 最大3回でGAS 6分制限に対応
- **待機時間**: 30秒間隔で適切な処理時間確保
- **軽量版チェック**: 必要な時のみ実行で効率性向上

### 8.2 データ処理最適化
- **範囲制限**: 21日前から当日の範囲でのみ処理
- **除外処理**: 除外対象の早期判定
- **バッチ処理**: 複数ウェビナーの一括処理

### 8.3 リソース管理
- **Drive操作**: 必要最小限のファイル操作
- **API呼び出し**: 適切な間隔でのAPI呼び出し
- **メモリ使用**: 効率的なデータ構造の使用

## 9. セキュリティ

### 9.1 認証情報管理
- **スクリプトプロパティ**: 機密情報の安全な管理
- **アクセストークン**: 適切な有効期限管理
- **権限管理**: 必要最小限の権限設定

### 9.2 データ保護
- **個人情報**: 適切な匿名化・暗号化
- **アクセス制御**: 認証されたユーザーのみアクセス
- **ログ管理**: セキュリティログの記録

## 10. 運用・保守

### 10.1 日常運用
- **自動実行**: 設定されたトリガーによる自動実行
- **エラー監視**: Slack通知によるエラー監視
- **ログ確認**: 処理状況の定期的な確認

### 10.2 定期メンテナンス
- **トークン更新**: アクセストークンの定期的な更新
- **設定確認**: スクリプトプロパティの設定確認
- **パフォーマンス監視**: 処理時間・エラー率の監視

### 10.3 トラブルシューティング
- **軽量テスト**: 問題発生時の動作確認
- **ログ分析**: エラーログの詳細分析
- **設定確認**: 各種設定値の確認

## 11. 制限事項・注意点

### 11.1 GAS制限
- **実行時間**: 6分制限に注意
- **API呼び出し**: 適切な間隔での呼び出し
- **ファイルサイズ**: アップロード可能なファイルサイズの制限

### 11.2 Zoom API制限
- **レート制限**: API呼び出し回数の制限
- **データ遅延**: アンケートデータの取得遅延の可能性
- **認証制限**: アクセストークンの有効期限

### 11.3 データ制限
- **行数制限**: スプレッドシートの行数制限
- **ファイル数**: Driveのファイル数制限
- **メール送信**: 1日あたりのメール送信制限

## 12. 今後の拡張性

### 12.1 機能拡張
- **新しいレポート形式**: 追加のレポート形式への対応
- **多言語対応**: 国際化への対応
- **モバイル対応**: モバイルデバイスからの操作

### 12.2 パフォーマンス向上
- **並列処理**: 複数ウェビナーの並列処理
- **キャッシュ機能**: データのキャッシュ機能
- **分散処理**: 複数GASプロジェクトでの分散処理

### 12.3 監視・分析機能
- **メトリクス収集**: 処理状況の詳細な分析
- **アラート機能**: 異常検知時の自動アラート
- **レポート機能**: 運用状況の定期レポート

---

**作成日**: 2025年8月16日  
**バージョン**: 8  
**作成者**: システム開発チーム  
**最終更新**: 2025年8月16日
